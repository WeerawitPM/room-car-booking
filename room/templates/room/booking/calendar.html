<div id="calendar"></div>

<!-- Include modal and toast template -->
{% include 'room/booking/toast.html' %}
{% include 'room/booking/modal_event.html' %}
{% include 'room/booking/modal_detail.html' %}

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
  $(document).ready(function () {
    var calendarEl = $('#calendar')[0]
    var colorToast = new bootstrap.Toast($('#colorToast')[0], { delay: 5000 })
    var dateToast = new bootstrap.Toast($('#dateToast')[0], { delay: 5000 })
    var selectedRoomId = null
  
    function setRoomId(id) {
      selectedRoomId = id
      fetchBookings(id)
      calendar.render()
    }
  
    function fetchBookings(roomId) {
      $.ajax({
        url: `{% url "fetch_bookings" %}`,
        method: 'GET',
        data: { room_id: roomId },
        success: function (response) {
          var bookings = JSON.parse(response.bookings)
          calendar.removeAllEvents()
          calendar.addEventSource(
            bookings.map(function (booking) {
              return {
                title: booking.title,
                start: booking.start_date,
                end: booking.end_date,
                color: booking.color,
                extendedProps: {
                  emp_id: booking.emp_id,
                  firstname: booking.first_name,
                  lastname: booking.last_name,
                  description: booking.description,
                  status: booking.status
                }
              }
            })
          )
        }
      })
    }
  
    var calendar = new FullCalendar.Calendar(calendarEl, {
      timeZone: 'UTC',
      eventTimeFormat: { hour: 'numeric', minute: '2-digit' },
      dayMaxEvents: true,
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'title prev,next today',
        center: 'addEventButton',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      // Setting the date format for the date picker and calendar
      views: {
        dayGridMonth: {
          titleFormat: { year: 'numeric', month: 'long' } // Month in Thai format
        },
        timeGridWeek: {
          titleFormat: { year: 'numeric', month: 'short', day: 'numeric' }
        },
        timeGridDay: {
          titleFormat: { year: 'numeric', month: 'short', day: 'numeric' }
        }
      },
      customButtons: {
        addEventButton: {
          text: 'add event...',
          click: function () {
            if (selectedRoomId) {
              $('#eventModal').modal('show')
            } else {
              alert('Please select a room first.')
            }
          }
        }
      },
      eventClick: function (info) {
        var eventObject = info.event
        //console.log(eventObject.start)
        $('#eventDetailEmployeeId').text(eventObject.extendedProps.emp_id)
        $('#eventDetailEmployeeName').text(eventObject.extendedProps.firstname + ' ' + eventObject.extendedProps.lastname)
        $('#eventDetailTitle').text(eventObject.title)
        $('#eventDetailDescription').text(eventObject.extendedProps.description)
        $('#eventDetailStart').text(formatDateTime(eventObject.start))
        $('#eventDetailEnd').text(formatDateTime(eventObject.end))
        // กำหนดสีพื้นหลังตามที่ได้รับจาก eventObject
        //$('#eventDetailColor').css('background-color', eventObject.backgroundColor)
        $('#eventDetailStatus').css('background-color', eventObject.color).text(eventObject.extendedProps.status)
        $('#eventDetailModal').modal('show')
      }
    })
  
    function formatDateTime(date) {
      return moment.utc(date).format('DD MMMM YYYY, HH:mm A')
    }
  
    $('#eventForm').on('submit', function (e) {
      e.preventDefault()
      var formData = $(this).serializeArray()
      var startDate = formData.find((field) => field.name === 'start_date').value
      var endDate = formData.find((field) => field.name === 'end_date').value
  
      if (startDate === endDate) {
        $('#dateToast .toast-body').text('Start date and end date cannot be the same.')
        var dateToast = new bootstrap.Toast($('#dateToast')[0], { delay: 5000 })
        dateToast.show()
        return
      }
  
      // Check if endDate is before startDate
      if (moment(endDate).isBefore(moment(startDate))) {
        $('#dateToast .toast-body').text('End date cannot be earlier than start date.')
        var dateToast = new bootstrap.Toast($('#dateToast')[0], { delay: 5000 })
        dateToast.show()
        return
      }
  
      var eventData = {
        title: formData.find((field) => field.name === 'title').value,
        start: startDate,
        end: endDate,
        description: formData.find((field) => field.name === 'description').value
      }
  
      $.ajax({
        url: '{% url "save_booking" %}',
        method: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          title: eventData.title,
          description: eventData.description,
          start_date: eventData.start,
          end_date: eventData.end,
          room_id: selectedRoomId
          //color: eventData.color
        },
        success: function (response) {
          fetchBookings(selectedRoomId)
          $('#eventModal').modal('hide')
          $('#eventForm')[0].reset()
        },
        error: function (error) {
          if (error.status === 400) {
            colorToast.show()
          }
          console.log(error)
        }
      })
    })
  
    // Add this section to set the room ID and load the calendar immediately
    if ($('.room-link').length > 0) {
      var firstRoomId = $('.room-link').first().data('room-id')
      setRoomId(firstRoomId)
    }
  
    $('.room-link').on('click', function () {
      var roomId = $(this).data('room-id')
      setRoomId(roomId)
    })
  
    $('#sidebarCollapse').on('click', function () {
      setTimeout(function () {
        calendar.render()
      }, 300)
    })
  })
</script>
